---
version: '2.0'

name: project_delete
description: Workbook that contains project_deletion workflows

workflows:
  init:
    type: direct
    input:
      - id
    tasks:
      check_identity:
        workflow: check_identity
        input:
          id: <% $.id %>
        publish:
          fim_lock: <% task(check_identity).result.fim_lock %>
        on-success:
          - fail: <% $.fim_lock != null and $.fim_lock = true %>
          - service_delete: <% $.fim_lock = null %>
      
      service_delete:
        workflow: service_delete.init
        input:
          id: <% $.id %>
        on-success:
          - identity

      identity:
        workflow: identity
        input:
          id: <% $.id %>

  check_identity:
    description: Checks if the project can be deleted
    type: direct
    input:
      - id
    output:
      fim_lock: <% $.fim_lock %>
    tasks:
      retrieve_project:
        action: keystone.projects_get
        input:
          project: <% $.id %>
        publish:
          fim_lock: <% task(retrieve_project).result.get("fim-lock") %>

  identity:
    description: Deletes all resources of a project on the identity service
    type: direct
    input:
      - id
    tasks:
      delete_project:
        action: keystone.projects_delete
        input:
          project: <% $.id %>
