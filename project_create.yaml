---
version: '2.0'

name: project_create
description: Workbook that contains project_creation workflows

workflows:
  launch:
    type: direct
    input:
      - id
      - name
      - description
      - enabled
      - owner
    output:
      id: <% $.project_id %>
      name: <% $.name %>
      description: <% $.description %>
      enabled: <% $.enabled %>
      owner: <% $.owner %>

    tasks:
      identity:
        workflow: identity
        input:
          id: <% $.id %>
          name: <% $.name %>
          domain: default
          description: <% $.description %>
          enabled: <% $.enabled %>
        publish:
          project_id: <% task(identity).result.id %>
        on-success:
          - blockstorage
          - compute
          - image
          - fileshare
          - orcherstration
          - network
          - container_infra
          - workengine

      compute:
        workflow: compute
        input:
          id: <% $.project_id %>

      blockstorage:
        workflow: blockstorage
        input:
          id: <% $.project_id %>

      image:
        workflow: image
        input:
          id: <% $.project_id %>

      fileshare:
        workflow: fileshare
        input:
          id: <% $.project_id %>

      orchestration:
        workflow: orchestration
        input:
          id: <% $.project_id %>

      network:
        workflow: network
        input:
          id: <% $.project_id %>

      container_infra:
        workflow: container_infra
        input:
          id: <% $.project_id %>

      workengine:
        workflow: workengine
        input:
          id: <% $.project_id %>

  identity:
    description: Creates a Project, assigns the ownership/membership
    type: direct
    input:
      - id
      - name
      - description
      - enabled
      - owner
    output:
      id: <% $.project_id %>
      name: <% $.name %>
      description: <% $.description %>
      enabled: <% $.enabled %>
      owner: <% $.owner %>
    tasks:
      project_exists:
        action: keystone.projects_get project=<% $.id %>
        publish:
          project_id: <% task(project_exists).result.id %>
        on-success:
          - get_user_id
        on-error:
          - create_project

      create_project:
        action: keystone.projects_create
        input:
          id: <% $.id %>
          name: <% $.name %>
          domain: default
          description: <% $.description %>
          enabled: <% $.enabled %>
        publish:
          project_id: <% task(create_project).result.id %>
        on-success:
          - get_user_id

      get_user_id:
        action: keystone.users_find
        input:
          name: <% $.owner %>
        publish:
          owner_id: <% task(get_user_id).result.id %>
        on-success:
          - get_owner_role_id
          - get_member_role_id
          - set_fim_properties: <% not ('Personal' in $.name)  %>
          - set_personal_project_properties: <% 'Personal' in $.name  %>

      get_owner_role_id:
        action: keystone.roles_find
        input:
          name: 'owner'
        publish:
          owner_role_id: <% task(get_owner_role_id).result.id %>
        on-success:
          - set_project_owner

      get_member_role_id:
        action: keystone.roles_find
        input:
          name: 'Member'
        publish:
          member_role_id: <% task(get_member_role_id).result.id %>
        on-success:
          - set_project_member

      set_project_owner:
        action: keystone.roles_grant
        input:
          role: <% $.owner_role_id %>
          user: <% $.owner_id %>
          project: <% $.project_id %>

      set_project_member:
        action: keystone.roles_grant
        input:
          role: <% $.member_role_id %>
          user: <% $.owner_id %>
          project: <% $.project_id %>

      set_fim_properties:
        action: keystone.projects_update project=<% $.project_id %> fim-lock=true fim-skip=true

      set_personal_project_properties:
        action: keystone.projects_update project=<% $.project_id %> accounting-group='personal' type='personal'

  compute:
    description: Initializes a project on the compute service sets default quotas
    type: direct
    input:
      - id
    tasks:
      update_compute_quota:
        action: nova.quotas_update
        input:
          tenant_id: <% $.id %>
          cores: 10
          ram: 20480
          instances: 5

  blockstorage:
    description: Initializes a project on the blockstorage service sets default quotas
    type: direct
    input:
      - id
    tasks:
      update_volume_quota:
        action: cinder.quotas_update
        input:
          tenant_id: <% $.id %>
          volumes: 10
          gigabytes: 100
          snapshots: 10
        on-success:
          - get_volume_types

      get_volume_types:
        action: cinder.volume_types_list
        publish:
          volume_type_names: <% task(get_volume_types).result.name %>
        on-success:
          - update_volume_quota_types

      update_volume_quota_types:
        with-items: vt_name in <% $.volume_type_names %>
        action: cinder.quotas_update tenant_id=<% $.id %> volumes_<% vt_name %>=10 gigabytes_<% vt_name %>=1000 snapshots_<% vt_name %>=10

  image:
    description: Initializes a project on the image service sets default quotas
    type: direct
    input:
      - id
    tasks:
      empty_task:
        action: std.echo output='skip'

  fileshare:
    description: Initializes a project on the fileshare service sets default quotas
    type: direct
    input:
      - id
    tasks:
      empty_task:
        action: std.echo output='skip'

  orchestration:
    description: Initializes a project on the orchestration service sets default quotas
    type: direct
    input:
      - id
    tasks:
      empty_task:
        action: std.echo output='skip'


  network:
    description: Initializes a project on the network service sets default quotas
    type: direct
    input:
      - id
    tasks:
      empty_task:
        action: std.echo output='skip'

  container_infra:
    description: Initializes a project on the container infrastructure service sets default quotas
    type: direct
    input:
      - id
    tasks:
      empty_task:
        action: std.echo output='skip'

  workengine:
    description: Initializes a project on the workflow service sets default quotas
    type: direct
    input:
      - id
    tasks:
      empty_task:
        action: std.echo output='skip'